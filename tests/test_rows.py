from collections import OrderedDict
from datetime import datetime

import pytz

import kobuddy
from kobuddy import Highlight, Book, Books

TEST_BOOK = Book(title='test title', author='test author', content_id='fwfwf', isbn='2424')

def test_hl_no_datecreated():
    row = OrderedDict([
        ('BookmarkID', 'bbbbb'),
        ('VolumeID', 'vvvv'),
        ('ContentID', 'cccc'),
        ('StartContainerPath', 'span#kobo\\.31\\.4'),
        ('StartContainerChildIndex', -99),
        ('StartOffset', 117),
        ('EndContainerPath', 'span#kobo\\.31\\.5'),
        ('EndContainerChildIndex', -99),
        ('EndOffset', 141),
        ('Text', '<blah blah quote>'),
        ('Annotation', None),
        ('ExtraAnnotationData', None),
        ('DateCreated', None),
        ('ChapterProgress', 0.75),
        ('Hidden', 'false'),
        ('Version', ''),
        ('DateModified', '2014-05-17T21:05:35Z'),
        ('Creator', None),
        ('UUID', None),
        ('UserID', '6fc7'),
        ('SyncTime', '2019-05-21T16:46:17Z'),
        ('Published', 'false'),
    ])
    hl = Highlight(row, TEST_BOOK)
    # TODO can we automate this?
    for attr in [a for a in dir(Highlight) if not a.startswith('_')]:
        value = getattr(hl, attr)
        assert value is not None

import pytest

# TODO maybe search for ExtraData markers?
@pytest.mark.parametrize('exp,extra', [
    (0 , '000000010000002C00500061006700650073005400750072006E00650064005400680069007300530065007300730069006F006E000000020000000000'),
    (0 , '000000030000003400450078007400720061004400610074006100530079006e00630065006400540069006d00650045006c006100700073006500640000000a000000000200300000002800450078007400720061004400610074006100530079006e0063006500640043006f0075006e00740000000200000000030000002e00450078007400720061004400610074006100520065006100640069006e0067005300650063006f006e006400730000000a00000000020030'),
    (35, '000000010000001E006500760065006E007400540069006D0065007300740061006D0070007300000009000000002300000003005C17566E00000003005C175B2400000003005C175D0C00000003005C175E1F00000003005C1967C300000003005C196FE800000003005C20EA0300000003005C20EE4100000003005C20F5C100000003005C22684300000003005C27F06A00000003005C27F92300000003005C28C9C300000003005C28CC6B00000003005C291EE500000003005C2E27FF00000003005C2F75B100000003005C31B2FE00000003005C3758DD00000003005C389B4800000003005C38E45600000003005C3C9E9300000003005C3F31FB00000003005C40BB7200000003005C419BA300000003005C419BE400000003005C419C1800000003005C44555F00000003005C460FA100000003005C460FD500000003005C47A15000000003005C47A16500000003005C47A18800000003005C47A19500000003005C47A243'),
    (1 , '000000030000001E006500760065006E007400540069006D0065007300740061006D0070007300000009000000000100000003005B4F241E00000018004D006F006E006500740069007A006100740069006F006E0000000001FFFFFFFF0000002000490073004D00610072006B0041007300460069006E00690073006800650064000000010000'),
    (13, '000000020000001E006500760065006E007400540069006D0065007300740061006D0070007300000009000000000D00000003005B55AC1100000003005B55D50400000003005B55D50900000003005B55D50B00000003005B55D53100000003005B55D53600000003005B55D53700000003005B55D53A00000003005B55D53C00000003005B55D53E00000003005B55D55800000003005B55FE7100000003005B56088C00000010005600690065007700540079007000650000000A000000000A0053006C006500650070'),
    (16, '000000020000001E006500760065006E007400540069006D0065007300740061006D0070007300000009000000001000000003005B71E87B00000003005B756BD900000003005B756BE100000003005B759E6800000003005B75C07C00000003005B76687800000003005B7AE4A300000003005B7B1FDD00000003005B7B274F00000003005B7B278300000003005B7B279800000003005B7B27E600000003005B7B281E00000003005B7B286500000003005B7B28C000000003005B7B28D300000010005600690065007700540079007000650000000A00000000160041006E006E006F0074006100740069006F006E0073'),
    (63, '000000030000001E006500760065006E007400540069006D0065007300740061006D0070007300000009000000003F00000003005B298B1200000003005B298B5100000003005B298B6000000003005B2A34F500000003005B2D218000000003005B2D397200000003005B2D3A7600000003005B2D42D700000003005B2D42F900000003005B2D430100000003005B2D430800000003005B30915800000003005B30918800000003005B30918C00000003005B30CE7000000003005B316E8900000003005B32C18900000003005B33C64800000003005B33C69100000003005B33C75500000003005B33C76900000003005B33F41400000003005B33F7F700000003005B35683700000003005B36626000000003005B3677E000000003005B375FD400000003005B37663D00000003005B378A1500000003005B3A620D00000003005B41421800000003005B4199A300000003005B41F80F00000003005B42210C00000003005B42FAD000000003005B43300100000003005B43304C00000003005B4330D000000003005B4330DA00000003005B46DF1E00000003005B482B7900000003005B48325D00000003005B48904300000003005B48979000000003005B4A6FD900000003005B4C259D00000003005B4C5DA500000003005B4C961500000003005B4D9D7300000003005B4E376300000003005B4E5F4600000003005B4F242D00000003005B4F2CF400000003005B4F5FA300000003005B5044F400000003005B50962700000003005B50CFDE00000003005B51801B00000003005B5180F700000003005B51830100000003005B51B5FE00000003005B51FA3D00000003005B5611AE00000010005600690065007700540079007000650000000A00000000080048006F006D006500000018004D006F006E006500740069007A006100740069006F006E0000000A00000000140053006900640065006C006F0061006400650064'),
    (45, '000000050000001E006500760065006E007400540069006D0065007300740061006D0070007300000009000000002D000000030059830867000000030059830928000000030059830BC00000000300598310560000000300598314C400000003005983150000000003005983152A00000003005985BE0B00000003005985BEA100000003005985C92E00000003005985CBEB0000000300598706B1000000030059884B2C000000030059885ACA000000030059885C0800000003005989A19D00000003005989A4860000000300598AF8370000000300598C5E370000000300598C6D9D0000000300598CE6EB0000000300598CE8420000000300598CE8450000000300598DA1A80000000300598E79310000000300598E7ACB00000003005991945100000003005992E19900000003005992E77B00000003005993DE0000000003005993DE1D00000003005993DE2400000003005993DE4E000000030059956AB100000003005998C2DB0000000300599D23FD0000000300599D25620000000300599FFB83000000030059A0C6EC000000030059A0D0F1000000030059A0EDC7000000030059A406E8000000030059A406FC00000003005A11F47500000003005A11F4BE00000018004D006F006E006500740069007A006100740069006F006E0000000A000000000800500061006900640000003400450078007400720061004400610074006100530079006E00630065006400540069006D00650045006C006100700073006500640000000A000000000200300000002800450078007400720061004400610074006100530079006E0063006500640043006F0075006E007400000002000000005A0000002E00450078007400720061004400610074006100520065006100640069006E0067005300650063006F006E006400730000000A00000000020030'),
    (4 , '000000060000001E006500760065006E007400540069006D0065007300740061006D0070007300000009000000000400000003005A3B9BFD00000003005A3CEA5600000003005A3CF7B300000003005A3D6C6100000010005600690065007700540079007000650000000A000000000A0053006C00650065007000000018004D006F006E006500740069007A006100740069006F006E0000000A000000000E00500072006500760069006500770000003400450078007400720061004400610074006100530079006E00630065006400540069006D00650045006C006100700073006500640000000A000000000200300000002800450078007400720061004400610074006100530079006E0063006500640043006F0075006E00740000000200000000010000002E00450078007400720061004400610074006100520065006100640069006E0067005300650063006F006E006400730000000A00000000020030'),
])
def test_iter_events_aux_Event(exp, extra):
    from kobuddy import _iter_events_aux_Event
    books = Books()
    books.add(TEST_BOOK)

    row = OrderedDict([
        ('EventType', 3),
        ('EventCount', 35),
        ('LastOccurrence', '2019-01-22T23:07:47.000'),
        ('ContentID', 'fwfwf'),
        ('Checksum', 'bd0fda782920dbaa57d593fa70bcf3de'),
        ('hex(ExtraData)', extra),
    ])
    import codecs
    print(codecs.decode(extra, 'hex'))
    res = list(_iter_events_aux_Event(row=row, books=books))
    assert len(res) == exp
    # if len(res) > 0:
    #     # TODO only works for thrid test, fix it later..
    #     assert res[0].dt  == datetime(year=2018, month=12, day=17, hour=7 , minute=55, second=26, tzinfo=pytz.utc)
    #     assert res[-1].dt == datetime(year=2019, month=1 , day=22, hour=23, minute=7 , second=47, tzinfo=pytz.utc)
